<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="modal.title">Kortex KI-Workflows - Modal Version</title>
  
  <script src="translations.js"></script>
  <script src="i18n.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #0a1628 0%, #09182F 100%);
      min-height: 100vh;
      color: white;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 60px 20px;
    }
    
    header {
      text-align: center;
      margin-bottom: 4rem;
    }
    
    h1 {
      font-size: 3rem;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .subtitle {
      font-size: 1.3rem;
      color: #94a3b8;
      margin-bottom: 1rem;
    }
    
    /* Demo Cards Grid */
    .demo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 3rem;
      margin-top: 3rem;
    }
    
    .demo-card-link {
      text-decoration: none;
      display: block;
      transition: transform 0.3s ease;
    }
    
    .demo-card-link:hover {
      transform: translateY(-8px);
    }
    
    .demo-card {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 16px;
      padding: 2.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .demo-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .demo-card:hover::before {
      opacity: 1;
    }
    
    .demo-card:hover {
      border-color: rgba(96, 165, 250, 0.5);
      box-shadow: 0 20px 60px rgba(59, 130, 246, 0.3);
    }
    
    .demo-icon {
      font-size: 4rem;
      margin-bottom: 1.5rem;
      display: block;
    }
    
    .demo-card h3 {
      font-size: 1.8rem;
      margin-bottom: 1rem;
      color: white;
      position: relative;
      z-index: 1;
    }
    
    .demo-card p {
      font-size: 1rem;
      color: #94a3b8;
      line-height: 1.6;
      margin-bottom: 1.5rem;
      position: relative;
      z-index: 1;
      flex-grow: 1;
    }
    
    .demo-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      position: relative;
      z-index: 1;
    }
    
    .tag {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    .tag.success {
      background: rgba(34, 197, 94, 0.2);
      color: #4ade80;
    }
    
    .arrow-icon {
      position: absolute;
      bottom: 2rem;
      right: 2rem;
      font-size: 2rem;
      font-weight: bold;
      color: #60a5fa;
      transition: transform 0.3s ease;
    }
    
    .demo-card:hover .arrow-icon {
      transform: translateX(8px);
    }
    
    /* ===== MODAL STYLES ===== */
    #workflow-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 10000;
      backdrop-filter: blur(8px);
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    #workflow-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #workflow-iframe-container {
      position: relative;
      width: 95%;
      height: 95%;
      max-width: 1600px;
      max-height: 950px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.6);
      overflow: hidden;
      animation: slideUp 0.4s ease;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    #workflow-close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #ef4444;
      color: white;
      border: none;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 28px;
      line-height: 1;
      z-index: 10001;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #workflow-close-btn:hover {
      background: #dc2626;
      transform: rotate(90deg) scale(1.1);
    }
    
    #workflow-iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 16px;
    }
    
    .loading-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 10000;
    }
    
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top: 4px solid #60a5fa;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #60a5fa;
      font-size: 1.1rem;
      font-weight: 500;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      h1 {
        font-size: 2rem;
      }
      
      .subtitle {
        font-size: 1rem;
      }
      
      .demo-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .demo-card {
        padding: 2rem;
      }
      
      #workflow-iframe-container {
        width: 100%;
        height: 100%;
        border-radius: 0;
      }
      
      #workflow-close-btn {
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1 data-i18n="modal.heading">üöÄ Kortex KI-Workflows</h1>
      <p class="subtitle" data-i18n="modal.subtitle">Intelligente Automatisierung f√ºr Ihr Business</p>
    </header>


    <!-- Demo Cards Grid -->
    <div class="demo-grid">
      
      <!-- Card 1: Business Card Extraction (n8n) ‚Äì Sample 1 -->
      <a href="#" class="demo-card-link" 
         data-workflow-url="https://n8n2.kortex-system.de/webhook/business-card-extraction" 
         data-params="sample=1"
         data-title="Visitenkarten Demo ‚Äì Sample 1"
         data-sample-image="https://karusocaminar.github.io/kortex-website/samples/bc-1.jpg">
        <div class="demo-card">
          <div style="text-align: center; margin-bottom: 1.5rem;">
            <img src="https://karusocaminar.github.io/kortex-website/samples/bc-1.jpg" 
                 alt="Visitenkarte 1" 
                 style="width: 100%; max-width: 600px; height: auto; object-fit: contain; border-radius: 12px; border: 2px solid rgba(148, 163, 184, 0.3); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); background: rgba(255, 255, 255, 0.05);"
                 onerror="this.style.display='none'">
          </div>
          <h3 style="margin-bottom: 0.5rem;" data-i18n="modal.card1.title">Business Card ‚Äì Sample 1</h3>
          <p style="font-size: 0.95rem; color: #94a3b8; margin: 0 0 1rem 0;" data-i18n="modal.card1.person">Oliver Krause - Datenschutzbeauftragter</p>
          <p style="font-size: 0.9rem;" data-i18n="modal.card1.description">Klicke auf diese Demo-Visitenkarte ‚Üí KI extrahiert automatisch Name, Firma, E-Mail, Telefon ‚Üí Ergebnis erscheint in der Tabelle.</p>
          
          <div class="demo-tags">
            <span class="tag" data-i18n="modal.tag.speed">‚ö° 5 Sek/Karte</span>
            <span class="tag success" data-i18n="modal.tag.accuracy">‚úÖ 95% Genauigkeit</span>
            <span class="tag" data-i18n="modal.tag.n8n">üîó n8n-Powered</span>
          </div>
          
          <span class="arrow-icon">‚Üí</span>
        </div>
      </a>
      
      <!-- Card 2: Business Card Extraction (n8n) ‚Äì Sample 2 -->
      <a href="#" class="demo-card-link" 
         data-workflow-url="https://n8n2.kortex-system.de/webhook/business-card-extraction" 
         data-params="sample=2"
         data-title="Visitenkarten Demo ‚Äì Sample 2"
         data-sample-image="https://karusocaminar.github.io/kortex-website/samples/bc-2.jpg">
        <div class="demo-card">
          <div style="text-align: center; margin-bottom: 1.5rem;">
            <img src="https://karusocaminar.github.io/kortex-website/samples/bc-2.jpg" 
                 alt="Visitenkarte 2" 
                 style="width: 100%; max-width: 600px; height: auto; object-fit: contain; border-radius: 12px; border: 2px solid rgba(148, 163, 184, 0.3); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); background: rgba(255, 255, 255, 0.05);"
                 onerror="this.style.display='none'">
          </div>
          <h3 style="margin-bottom: 0.5rem;" data-i18n="modal.card2.title">Business Card ‚Äì Sample 2</h3>
          <p style="font-size: 0.95rem; color: #94a3b8; margin: 0 0 1rem 0;" data-i18n="modal.card2.person">Gabi Gra√ünick - Bestattungen Gra√ünick</p>
          <p style="font-size: 0.9rem;" data-i18n="modal.card2.description">Klicke auf diese Demo-Visitenkarte ‚Üí KI extrahiert automatisch Name, Firma, E-Mail, Telefon ‚Üí Ergebnis erscheint in der Tabelle.</p>
          
          <div class="demo-tags">
            <span class="tag" data-i18n="modal.tag.speed">‚ö° 5 Sek/Karte</span>
            <span class="tag success" data-i18n="modal.tag.accuracy">‚úÖ 95% Genauigkeit</span>
            <span class="tag" data-i18n="modal.tag.n8n">üîó n8n-Powered</span>
          </div>
          
          <span class="arrow-icon">‚Üí</span>
        </div>
      </a>
      
      <!-- Card 3: Business Card Extraction (n8n) ‚Äì Sample 3 -->
      <a href="#" class="demo-card-link" 
         data-workflow-url="https://n8n2.kortex-system.de/webhook/business-card-extraction" 
         data-params="sample=3"
         data-title="Visitenkarten Demo ‚Äì Sample 3"
         data-sample-image="https://karusocaminar.github.io/kortex-website/samples/bc-3.jpg">
        <div class="demo-card">
          <div style="text-align: center; margin-bottom: 1.5rem;">
            <img src="https://karusocaminar.github.io/kortex-website/samples/bc-3.jpg" 
                 alt="Visitenkarte 3" 
                 style="width: 100%; max-width: 600px; height: auto; object-fit: contain; border-radius: 12px; border: 2px solid rgba(148, 163, 184, 0.3); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); background: rgba(255, 255, 255, 0.05);"
                 onerror="this.style.display='none'">
          </div>
          <h3 style="margin-bottom: 0.5rem;" data-i18n="modal.card3.title">Business Card ‚Äì Sample 3</h3>
          <p style="font-size: 0.95rem; color: #94a3b8; margin: 0 0 1rem 0;" data-i18n="modal.card3.person">Klicke auf diese Demo-Visitenkarte ‚Üí KI extrahiert automatisch alle Kontaktdaten</p>
          <p style="font-size: 0.9rem;" data-i18n="modal.card3.description">Klicke auf diese Demo-Visitenkarte ‚Üí KI extrahiert automatisch Name, Firma, E-Mail, Telefon ‚Üí Ergebnis erscheint in der Tabelle.</p>
          
          <div class="demo-tags">
            <span class="tag" data-i18n="modal.tag.speed">‚ö° 5 Sek/Karte</span>
            <span class="tag success" data-i18n="modal.tag.accuracy">‚úÖ 95% Genauigkeit</span>
            <span class="tag" data-i18n="modal.tag.n8n">üîó n8n-Powered</span>
          </div>
          
          <span class="arrow-icon">‚Üí</span>
        </div>
      </a>
      
      <!-- Card 4: Eigene Visitenkarte hochladen (n8n Form) -->
      <label for="business-card-upload-input" class="demo-card-link" style="cursor: pointer;">
        <div class="demo-card">
          <span class="demo-icon">ü™™</span>
          <h3 data-i18n="modal.card4.title">Eigene Visitenkarte hochladen</h3>
          <p data-i18n="modal.card4.description">Klicke hier ‚Üí W√§hle deine Visitenkarte ‚Üí KI extrahiert ‚Üí Ergebnis erscheint in der Tabelle unten.</p>
          
          <div class="demo-tags">
            <span class="tag" data-i18n="modal.tag.gdpr">üîí DSGVO</span>
            <span class="tag success" data-i18n="modal.tag.upload">üì• Upload</span>
            <span class="tag" data-i18n="modal.tag.ai">üß† KI</span>
          </div>
          
          <span class="arrow-icon">‚Üí</span>
        </div>
      </label>
      <input type="file" id="business-card-upload-input" accept="image/jpeg,image/png,image/jpg" style="display: none;">
      
    </div>

    <!-- Results Section -->
    <div style="margin-top: 3rem; background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 16px;">
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.25rem; border-bottom: 1px solid rgba(148, 163, 184, 0.2);">
        <div style="font-weight: 600;" data-i18n="modal.results.title">Extrahierte Kontaktdaten <span id="results-count" style="font-weight: normal; color: #94a3b8; font-size: 0.9em; margin-left: 0.5rem;">(0)</span></div>
        <div style="display: flex; gap: 0.5rem;">
          <button id="btn-clear-results" style="background:#ef4444;color:white;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:0.9rem;" data-i18n="modal.results.clear" data-i18n-aria-label="modal.results.clear">üóëÔ∏è L√∂schen</button>
          <button id="btn-download-csv" style="background:#1e40af;color:white;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;" data-i18n="modal.results.downloadCsv">CSV herunterladen</button>
          <button id="btn-download-json" style="background:#0f766e;color:white;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;" data-i18n="modal.results.downloadJson">JSON herunterladen</button>
        </div>
      </div>
      <div style="overflow-x: auto;">
        <table id="results-table" style="width:100%; border-collapse: collapse;">
          <thead>
            <tr style="background: rgba(148, 163, 184, 0.15); text-align: left;">
              <th style="padding: 12px 16px; border-bottom: 1px solid rgba(148,163,184,0.2);" data-i18n="modal.table.name">Name</th>
              <th style="padding: 12px 16px; border-bottom: 1px solid rgba(148,163,184,0.2);" data-i18n="modal.table.company">Firma</th>
              <th style="padding: 12px 16px; border-bottom: 1px solid rgba(148,163,184,0.2);" data-i18n="modal.table.email">E-Mail</th>
              <th style="padding: 12px 16px; border-bottom: 1px solid rgba(148,163,184,0.2);" data-i18n="modal.table.phone">Telefon</th>
              <th style="padding: 12px 16px; border-bottom: 1px solid rgba(148,163,184,0.2);" data-i18n="modal.table.address">Adresse</th>
              <th style="padding: 12px 16px; border-bottom: 1px solid rgba(148,163,184,0.2);" data-i18n="modal.table.source">Quelle</th>
              <th style="padding: 12px 16px; border-bottom: 1px solid rgba(148,163,184,0.2);" data-i18n="modal.table.time">Zeit</th>
            </tr>
          </thead>
          <tbody id="results-tbody">
            <tr>
              <td colspan="7" style="padding:16px; color:#94a3b8;" data-i18n="modal.results.empty">Noch keine Ergebnisse. Starte eine Demo oben.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Workflow Modal -->
  <div id="workflow-modal">
    <div id="workflow-iframe-container">
      <button id="workflow-close-btn" aria-label="Schlie√üen">&times;</button>
      <div class="loading-indicator" id="loading-indicator">
        <div class="spinner"></div>
        <p class="loading-text">Workflow wird geladen...</p>
      </div>
      <iframe 
        id="workflow-iframe"
        title="Workflow"
        allow="camera; microphone; clipboard-write"
        sandbox="allow-same-origin allow-scripts allow-forms allow-popups"
      ></iframe>
    </div>
  </div>

  <!-- JavaScript for Modal Handling -->
  <script>
    // ========================================
    // MODAL FUNCTIONS
    // ========================================
    
    async function openWorkflowModal(workflowUrl, workflowTitle, uploadFile = null) {
      const modal = document.getElementById('workflow-modal');
      const iframe = document.getElementById('workflow-iframe');
      const loading = document.getElementById('loading-indicator');
      
      // Validierung - pr√ºfe ob URL konfiguriert ist
      if (!workflowUrl) {
        alert('‚ö†Ô∏è Workflow-URL ist nicht konfiguriert!');
        return;
      }
      
      // Zeige Modal sofort
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
      loading.style.display = 'block';
      loading.innerHTML = '<div class="spinner"></div><p class="loading-text">üîÑ KI-Extraktion startet...</p>';
      
      try {
        // Hole extra Params (z.B. sample=1)
        // Suche nach Link mit data-title ODER falls workflowTitle speziell f√ºr Upload
        let activeLink = document.querySelector(`.demo-card-link[data-title="${workflowTitle}"]`);
        
        // Falls kein Link gefunden (z.B. bei Upload), versuche alternativen Selector
        if (!activeLink && workflowTitle === 'Eigene Visitenkarte hochladen') {
          // F√ºr Upload gibt es keinen data-title, aber wir haben kein sample-Parameter
          activeLink = null;
        }
        
        const extraParams = activeLink?.getAttribute('data-params') || '';
        
        // Baue Webhook-URL mit Parametern
        const webhookUrl = extraParams
          ? `${workflowUrl}${workflowUrl.includes('?') ? '&' : '?'}${extraParams}`
          : workflowUrl;
        
        // Detailliertes Logging starten
        const logTimestamp = new Date().toISOString();
        const logId = `workflow-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        
        // Log-Objekt f√ºr persistente Speicherung
        const workflowLog = {
          id: logId,
          timestamp: logTimestamp,
          workflowUrl: webhookUrl,
          sampleParam: sampleParam || 'Upload',
          workflowTitle: workflowTitle,
          method: extraParams ? 'GET' : 'POST',
          status: 'started',
          events: [],
          errors: [],
          response: null,
          duration: null
        };
        
        // Speichere Log in localStorage
        const storedLogs = JSON.parse(localStorage.getItem('workflowLogs') || '[]');
        storedLogs.unshift(workflowLog);
        // Behalte nur die letzten 50 Logs
        if (storedLogs.length > 50) {
          storedLogs.pop();
        }
        localStorage.setItem('workflowLogs', JSON.stringify(storedLogs));
        
        console.group(`üöÄ Workflow gestartet [${logId}]`);
        console.log('‚è∞ Zeitstempel:', logTimestamp);
        console.log('üåê Webhook URL:', webhookUrl);
        console.log('üìù Sample Parameter:', sampleParam || 'Upload');
        console.log('üìã Workflow Titel:', workflowTitle);
        
        // Helper-Funktion zum Hinzuf√ºgen von Log-Events
        function addLogEvent(type, data) {
          workflowLog.events.push({
            type: type,
            timestamp: new Date().toISOString(),
            data: data
          });
          // Update in localStorage
          const logs = JSON.parse(localStorage.getItem('workflowLogs') || '[]');
          const logIndex = logs.findIndex(l => l.id === logId);
          if (logIndex !== -1) {
            logs[logIndex] = workflowLog;
            localStorage.setItem('workflowLogs', JSON.stringify(logs));
          }
        }
        
        // Triggere Workflow im Hintergrund
        // F√ºr Samples: GET Request, f√ºr Upload: POST mit FormData
        const method = extraParams ? 'GET' : 'POST';
        let fetchOptions = {
          method: method,
        };
        
        // F√ºr Upload: F√ºge File hinzu (entweder als Parameter oder vom File Input)
        if (method === 'POST') {
          let fileToUpload = uploadFile;
          
          // Falls kein File als Parameter √ºbergeben wurde, pr√ºfe File Input
          if (!fileToUpload) {
            const fileInput = document.getElementById('business-card-upload-input');
            if (fileInput && fileInput.files && fileInput.files.length > 0) {
              fileToUpload = fileInput.files[0];
            }
          }
          
          if (fileToUpload) {
            const formData = new FormData();
            formData.append('file', fileToUpload);
            fetchOptions.body = formData;
            // FormData setzt Content-Type automatisch (mit boundary)
            fetchOptions.headers = {};
            console.log('üìé Sende File:', fileToUpload.name, fileToUpload.size, 'bytes');
          } else {
            // Kein File - normaler POST ohne Body
            fetchOptions.headers = {
              'Content-Type': 'application/json'
            };
          }
        }
        
        const requestData = {
          method: fetchOptions.method,
          url: webhookUrl,
          hasBody: !!fetchOptions.body,
          headers: fetchOptions.headers,
          bodyType: fetchOptions.body ? (fetchOptions.body instanceof FormData ? 'FormData' : 'JSON') : 'none'
        };
        addLogEvent('request', requestData);
        
        console.log('üåê Sende Request:', requestData);
        
        // Performance-Tracking
        const requestStartTime = performance.now();
        
        let response;
        try {
          response = await fetch(webhookUrl, fetchOptions);
        } catch (fetchError) {
          console.error('‚ùå Fetch Fehler:', fetchError);
          
          // Detaillierte Fehlermeldung
          let errorMessage = 'Failed to fetch';
          if (fetchError.message) {
            errorMessage = fetchError.message;
          } else if (fetchError.name === 'TypeError' && fetchError.message.includes('Failed to fetch')) {
            errorMessage = 'CORS-Fehler oder Netzwerk-Problem. Pr√ºfe ob n8n Webhook erreichbar ist.\n\nM√∂gliche L√∂sungen:\n1. n8n Workflow ist nicht aktiviert\n2. Webhook-URL ist falsch\n3. CORS ist nicht konfiguriert\n4. n8n Server ist offline';
          }
          
          // Zeige detaillierte Fehlerinformationen
          console.error('üîç Debug Info:', {
            workflowUrl: webhookUrl,
            method: fetchOptions.method,
            hasBody: !!fetchOptions.body,
            error: fetchError
          });
          
          throw new Error(errorMessage);
        }
        
        const requestDuration = (performance.now() - requestStartTime).toFixed(2);
        workflowLog.duration = `${requestDuration}ms`;
        
        const responseData_log = {
          status: response.status,
          statusText: response.statusText,
          ok: response.ok,
          headers: Object.fromEntries(response.headers.entries()),
          duration: `${requestDuration}ms`,
          timestamp: new Date().toISOString()
        };
        addLogEvent('response', responseData_log);
        
        console.log('‚úÖ Response erhalten:', responseData_log);
        
        if (!response.ok) {
          const errorText = await response.text().catch(() => 'Keine Details');
          const errorData = {
            status: response.status,
            statusText: response.statusText,
            body: errorText,
            type: 'http_error'
          };
          workflowLog.errors.push(errorData);
          workflowLog.status = 'error';
          addLogEvent('error', errorData);
          
          // Update in localStorage
          const logs = JSON.parse(localStorage.getItem('workflowLogs') || '[]');
          const logIndex = logs.findIndex(l => l.id === logId);
          if (logIndex !== -1) {
            logs[logIndex] = workflowLog;
            localStorage.setItem('workflowLogs', JSON.stringify(logs));
          }
          
          console.error('‚ùå HTTP Fehler:', errorData);
          throw new Error(`HTTP ${response.status}: ${response.statusText}\n${errorText}`);
        }
        
        const responseData = await response.json().catch(async () => {
          // Falls keine JSON-Response, versuche Text
          const text = await response.text();
          console.warn('‚ö†Ô∏è Keine JSON-Response, erhalten:', text);
          return { message: text };
        });
        workflowLog.response = responseData;
        workflowLog.status = 'success';
        
        const responseStructure = {
          type: responseData.type || 'unknown',
          hasPayload: !!responseData.payload,
          isArray: Array.isArray(responseData),
          keys: Object.keys(responseData)
        };
        addLogEvent('response_parsed', responseStructure);
        
        // Update in localStorage
        const logs = JSON.parse(localStorage.getItem('workflowLogs') || '[]');
        const logIndex = logs.findIndex(l => l.id === logId);
        if (logIndex !== -1) {
          logs[logIndex] = workflowLog;
          localStorage.setItem('workflowLogs', JSON.stringify(logs));
        }
        
        console.log('‚úÖ Workflow Response:', responseData);
        console.log('üìä Response Struktur:', responseStructure);
        
        // Verarbeite Response-Daten direkt (f√ºr Upload oder wenn Daten sofort zur√ºckkommen)
        if (responseData.type === 'business-card-processed' && responseData.payload) {
          const p = responseData.payload;
          extractedResults.unshift({
            name: p.name || '',
            company: p.company || '',
            email: p.email || '',
            phone: p.phone || '',
            address: p.address || '',
            city: p.city || '',
            source: p.source || (p.sample ? `Sample ${p.sample}` : 'Upload'),
            timestamp: p.timestamp || new Date().toISOString()
          });
          renderResults();
          console.log('‚úÖ Daten in Tabelle eingef√ºgt:', {
            name: p.name || '(leer)',
            company: p.company || '(leer)',
            email: p.email || '(leer)',
            source: p.source || (p.sample ? `Sample ${p.sample}` : 'Upload')
          });
        }
        
        // Wenn Response ein Array ist (n8n kann Arrays zur√ºckgeben)
        if (Array.isArray(responseData) && responseData.length > 0) {
          responseData.forEach(item => {
            if (item.type === 'business-card-processed' && item.payload) {
              const p = item.payload;
              extractedResults.unshift({
                name: p.name || '',
                company: p.company || '',
                email: p.email || '',
                phone: p.phone || '',
                address: p.address || '',
                city: p.city || '',
                source: p.source || (p.sample ? `Sample ${p.sample}` : 'Upload'),
                timestamp: p.timestamp || new Date().toISOString()
              });
            }
          });
          renderResults();
          console.log(`‚úÖ Array-Daten in Tabelle eingef√ºgt: ${responseData.length} Eintr√§ge`);
        }
        
        console.groupEnd(); // Workflow-Log-Gruppe schlie√üen
        
        // Update Loading-State wenn Response kommt
        loading.innerHTML = '<div class="spinner"></div><p class="loading-text">‚úÖ Workflow gestartet - Extraktion l√§uft...</p>';
        
        // Zeige Workflow-Visualisierung (Loading-State statt statischem Demo-Bild)
        if (responseData.executionUrl) {
          // Option 1: Falls n8n eine Execution-URL zur√ºckgibt, lade diese (echte Workflow-Visualisierung)
          iframe.src = responseData.executionUrl;
          loading.style.display = 'none';
        } else {
          // Option 2: Zeige Loading-State mit Spinner statt statischem Demo-Bild
          iframe.srcdoc = `
            <html>
              <head>
                <style>
                  * { box-sizing: border-box; }
                  body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    margin: 0;
                    padding: 1rem;
                    background: linear-gradient(135deg, #0a1628 0%, #09182F 100%);
                    color: white;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    height: 100vh;
                    overflow: hidden;
                  }
                  .spinner-container {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    gap: 1.5rem;
                  }
                  .spinner {
                    width: 60px;
                    height: 60px;
                    border: 4px solid rgba(255, 255, 255, 0.1);
                    border-top-color: #3b82f6;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                  }
                  @keyframes spin {
                    to { transform: rotate(360deg); }
                  }
                  .loading-text {
                    font-size: 1.2rem;
                    color: #cbd5e1;
                    font-weight: 500;
                    text-align: center;
                  }
                  .info-text {
                    font-size: 0.9rem;
                    color: #94a3b8;
                    text-align: center;
                    margin-top: 1rem;
                  }
                </style>
              </head>
              <body>
                <div class="spinner-container">
                  <div class="spinner"></div>
                  <div class="loading-text" data-i18n="modal.workflow.extracting">KI extrahiert Kontaktdaten...</div>
                  <div class="info-text" data-i18n="modal.workflow.background">
                    Die Extraktion l√§uft im Hintergrund. Ergebnisse erscheinen automatisch in der Tabelle.
                  </div>
                </div>
              </body>
            </html>
          `;
          
          // Verstecke Loading nach Workflow abgeschlossen (wird durch Response-Handling aktualisiert)
          // Loading bleibt sichtbar bis echte Response kommt
        }
        
        // Verstecke Loading-Indicator nach kurzer Zeit (Workflow l√§uft im Hintergrund)
        setTimeout(() => {
          loading.style.display = 'none';
        }, 2000);
        
        } catch (error) {
          const errorTimestamp = new Date().toISOString();
          const errorDetails = {
            message: error.message || 'Unbekannter Fehler',
            name: error.name || 'Error',
            stack: error.stack || 'Kein Stack-Trace',
            workflowUrl: webhookUrl,
            sampleParam: sampleParam || 'Upload',
            type: 'exception',
            timestamp: errorTimestamp
          };
          
          // Speichere Fehler in Log
          if (typeof workflowLog !== 'undefined') {
            workflowLog.errors.push(errorDetails);
            workflowLog.status = 'error';
            
            // Update in localStorage
            const logs = JSON.parse(localStorage.getItem('workflowLogs') || '[]');
            const logIndex = logs.findIndex(l => l.id === logId);
            if (logIndex !== -1) {
              logs[logIndex] = workflowLog;
              localStorage.setItem('workflowLogs', JSON.stringify(logs));
            }
          }
          
          console.group('‚ùå Workflow Fehler');
          console.error('‚è∞ Zeitstempel:', errorTimestamp);
          console.error('‚ùå Fehler beim Triggern des Workflows:', error);
          console.error('üìã Fehler Details:', errorDetails);
          console.groupEnd();
          
          loading.innerHTML = '<p style="color: #ef4444;">‚ö†Ô∏è Fehler beim Starten des Workflows</p>';
        
        // Zeige Fehler-Meldung
        iframe.srcdoc = `
          <html>
            <head>
              <style>
                body {
                  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  height: 100vh;
                  margin: 0;
                  background: linear-gradient(135deg, #0a1628 0%, #09182F 100%);
                  color: white;
                }
                .container {
                  text-align: center;
                  padding: 2rem;
                }
                h2 { margin: 0 0 1rem; color: #ef4444; }
                p { color: #94a3b8; }
              </style>
            </head>
            <body>
              <div class="container">
                <h2>‚ö†Ô∏è Fehler</h2>
                <p>${error.message}</p>
              </div>
            </body>
          </html>
        `;
      }
      
      // Analytics (optional)
      if (typeof gtag !== 'undefined') {
        gtag('event', 'workflow_opened', {
          'event_category': 'engagement',
          'event_label': workflowTitle,
          'workflow_url': workflowUrl
        });
      }
    }
    
    function closeWorkflowModal() {
      const modal = document.getElementById('workflow-modal');
      const iframe = document.getElementById('workflow-iframe');
      
      modal.classList.remove('active');
      document.body.style.overflow = '';
      
      // Optional: Clear iframe after closing (saves memory)
      // Uncomment if you want to reload workflow each time
      // setTimeout(() => {
      //   iframe.src = '';
      // }, 300);
      
      // Analytics (optional)
      if (typeof gtag !== 'undefined') {
        gtag('event', 'workflow_closed', {
          'event_category': 'engagement'
        });
      }
    }
    
    // ========================================
    // EVENT LISTENERS
    // ========================================
    
    document.addEventListener('DOMContentLoaded', () => {
      // Click handlers for demo cards
      const links = document.querySelectorAll('.demo-card-link');
      
      console.log('üìã Gefundene Demo-Cards:', links.length);
      links.forEach((link, index) => {
        const url = link.getAttribute('data-workflow-url');
        const title = link.getAttribute('data-title');
        console.log(`Card ${index + 1}:`, { url, title, hasUrl: !!url });
      });
      
      links.forEach(link => {
        link.addEventListener('click', async (e) => {
          e.preventDefault();
          
          // Skip Upload Label - wird separat behandelt
          if (link.tagName === 'LABEL' && link.getAttribute('for') === 'business-card-upload-input') {
            return; // Lass den File Input Handler das √ºbernehmen
          }
          
          const workflowUrl = link.getAttribute('data-workflow-url');
          const workflowTitle = link.getAttribute('data-title');
          const sampleParam = link.getAttribute('data-params');
          
          console.log('üîç Click auf Card:', { workflowUrl, workflowTitle, sampleParam });
          
          // KEINE Demo-Daten mehr - nur echte AI-Responses werden angezeigt
          // √ñffne Modal und triggere Workflow
          if (!workflowUrl) {
            console.error('‚ùå Workflow-URL nicht gefunden f√ºr:', workflowTitle);
            alert('‚ö†Ô∏è Workflow-URL ist nicht konfiguriert! Bitte pr√ºfe die data-workflow-url Attribute.');
            return;
          }
          await openWorkflowModal(workflowUrl, workflowTitle);
          
          // Modal bleibt offen - Ergebnisse erscheinen automatisch in der Tabelle
          // Nutzer kann Modal manuell schlie√üen oder es bleibt offen bis Results kommen
        });
      });
      
      // File Input Handler f√ºr Upload
      const fileInput = document.getElementById('business-card-upload-input');
      const uploadLabel = document.querySelector('label[for="business-card-upload-input"]');
      
      // File Input Handler f√ºr Upload
      // WICHTIG: Label-Click muss File Input triggern!
      if (uploadLabel) {
        uploadLabel.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          // Verhindere dass Label-Click den normalen Card-Handler ausl√∂st
          if (e.target === uploadLabel || e.target.closest('.demo-card')) {
            // √ñffne File Input Dialog
            if (fileInput) {
              fileInput.click();
            }
            return false;
          }
        });
      }
      
      if (fileInput) {
        // Stelle sicher, dass File Input sichtbar ist f√ºr Screen Reader
        fileInput.setAttribute('aria-label', 'Visitenkarte hochladen');
        
        fileInput.addEventListener('change', async (e) => {
          const file = e.target.files?.[0];
          if (!file) {
            console.log('‚ö†Ô∏è Keine Datei ausgew√§hlt');
            return;
          }
          
          // Validiere Datei
          if (!file.type.startsWith('image/')) {
            alert('‚ö†Ô∏è Bitte laden Sie nur Bilddateien (JPG, PNG) hoch!');
            fileInput.value = '';
            return;
          }
          
          if (file.size > 10 * 1024 * 1024) {
            alert('‚ö†Ô∏è Die Datei ist zu gro√ü (max. 10 MB)!');
            fileInput.value = '';
            return;
          }
          
          const workflowUrl = 'https://n8n2.kortex-system.de/webhook/business-card-extraction';
          console.log('üì§ Upload gestartet:', { workflowUrl, fileName: file.name, fileSize: file.size });
          
          // √ñffne Modal und √ºbergebe File direkt
          await openWorkflowModal(workflowUrl, 'Eigene Visitenkarte hochladen', file);
          
          // Modal bleibt offen - Ergebnisse erscheinen automatisch in der Tabelle
          // Nutzer kann Modal manuell schlie√üen oder es bleibt offen bis Results kommen
          
          // Reset File Input nach Upload
          fileInput.value = '';
        });
      }
      
      // Close button
      document.getElementById('workflow-close-btn').addEventListener('click', closeWorkflowModal);
      
      // Close on ESC key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeWorkflowModal();
        }
      });
      
      // Close on background click
      document.getElementById('workflow-modal').addEventListener('click', (e) => {
        if (e.target.id === 'workflow-modal') {
          closeWorkflowModal();
        }
      });
      
      console.log('‚úÖ Kortex n8n Modal Integration geladen');
      console.log('üìä Gefundene Demo-Cards:', links.length);
      
      // Update translations when language changes
      window.addEventListener('languagechange', () => {
        if (window.i18n) {
          window.i18n.updateTranslations();
        }
      });

      // Download Buttons
      document.getElementById('btn-download-csv')?.addEventListener('click', downloadCSV);
      document.getElementById('btn-download-json')?.addEventListener('click', downloadJSON);
      
      // Clear Button
      document.getElementById('btn-clear-results')?.addEventListener('click', () => {
        const confirmText = window.i18n?.t('modal.results.confirm') || 'M√∂chten Sie wirklich alle extrahierten Kontaktdaten l√∂schen?';
        if (extractedResults.length > 0 && confirm(confirmText)) {
          clearAllResults();
        }
      });
      
      // Automatisches L√∂schen alle 1 Stunde (3600 Sekunden = 3600000 Millisekunden)
      setInterval(() => {
        if (extractedResults.length > 0) {
          console.log('üïê Automatisches L√∂schen: Alle Daten werden nach 1 Stunde bereinigt');
          clearAllResults(false); // Keine Best√§tigung beim automatischen L√∂schen
        }
      }, 3600000); // 1 Stunde = 3600000 ms
      
      console.log('‚úÖ Automatisches L√∂schen aktiviert: Alle 1 Stunde');
    });
    
    // ========================================
    // COMMUNICATION WITH IFRAME (optional)
    // ========================================
    
    // Ergebnisse lokal halten
    const extractedResults = [];

    function renderResults() {
      const tbody = document.getElementById('results-tbody');
      const countElement = document.getElementById('results-count');
      
      if (!tbody) return;
      
      // Update count
      if (countElement) {
        countElement.textContent = `(${extractedResults.length})`;
      }
      
      if (extractedResults.length === 0) {
        const emptyText = window.i18n?.t('modal.results.empty') || 'Noch keine Ergebnisse. Starte eine Demo oben.';
        tbody.innerHTML = `<tr><td colspan="7" style="padding:16px; color:#94a3b8;">${emptyText}</td></tr>`;
        return;
      }
      tbody.innerHTML = extractedResults.map((r, index) => {
        const address = (r.address || '') + (r.city ? (r.address ? ', ' : '') + r.city : '');
        return `
        <tr>
          <td style="padding:12px 16px; border-top: 1px solid rgba(148,163,184,0.15);">${escapeHtml(r.name || '')}</td>
          <td style="padding:12px 16px; border-top: 1px solid rgba(148,163,184,0.15);">${escapeHtml(r.company || '')}</td>
          <td style="padding:12px 16px; border-top: 1px solid rgba(148,163,184,0.15);">${escapeHtml(r.email || '')}</td>
          <td style="padding:12px 16px; border-top: 1px solid rgba(148,163,184,0.15);">${escapeHtml(r.phone || '')}</td>
          <td style="padding:12px 16px; border-top: 1px solid rgba(148,163,184,0.15);">${escapeHtml(address || '')}</td>
          <td style="padding:12px 16px; border-top: 1px solid rgba(148,163,184,0.15);">${escapeHtml(r.source || '')}</td>
          <td style="padding:12px 16px; border-top: 1px solid rgba(148,163,184,0.15);">${new Date(r.timestamp).toLocaleString()}</td>
        </tr>
      `;
      }).join('');
    }
    
    function clearAllResults(showConfirm = true) {
      extractedResults.length = 0; // Array leeren
      renderResults();
      console.log('üóëÔ∏è Alle Kontaktdaten wurden gel√∂scht');
      
      // Optional: Toast-Benachrichtigung (falls gew√ºnscht)
      if (showConfirm) {
        // Kurze visuelle Best√§tigung
        const btn = document.getElementById('btn-clear-results');
        if (btn) {
          const originalText = btn.textContent;
          btn.textContent = '‚úÖ Gel√∂scht!';
          btn.style.background = '#22c55e';
          setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = '#ef4444';
          }, 2000);
        }
      }
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"]+/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

      function downloadCSV() {
      if (extractedResults.length === 0) return;
      const headers = ['name','company','email','phone','address','city','source','timestamp'];
      const csv = [headers.join(',')].concat(
        extractedResults.map(r => headers.map(h => {
          const val = r[h] != null ? String(r[h]) : '';
          // Quote and escape
          return '"' + val.replace(/"/g, '""') + '"';
        }).join(','))
      ).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'business-cards.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function downloadJSON() {
      if (extractedResults.length === 0) return;
      const blob = new Blob([JSON.stringify(extractedResults, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'business-cards.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    window.addEventListener('message', (event) => {
      // Security check - adjust origins as needed
      const allowedOrigins = [
        'https://koretex-invoice-db.onrender.com',
        'https://n8n.kortex.de',
        'http://localhost:5000'
      ];
      
      // Check if message is from an allowed origin
      const isAllowed = allowedOrigins.some(origin => event.origin.includes(origin));
      if (!isAllowed) {
        return;
      }
      
      console.log('üì© Message from workflow:', event.data);
      
      // Handle different event types
      if (event.data?.type === 'business-card-processed') {
        const p = event.data.payload || {};
          extractedResults.unshift({
            name: p.name || '',
            company: p.company || '',
            email: p.email || '',
            phone: p.phone || '',
            address: p.address || '',
            city: p.city || '',
            source: p.source || (p.sample ? `Sample ${p.sample}` : 'Upload'),
            timestamp: p.timestamp || new Date().toISOString()
          });
        renderResults();
      }

      if (event.data.type === 'workflow-complete') {
        console.log('‚úÖ Workflow abgeschlossen');
        // Optional: Auto-close modal after completion
        // setTimeout(() => closeWorkflowModal(), 2000);
      }
      
      if (event.data.type === 'close-requested') {
        closeWorkflowModal();
      }
    });
  </script>
</body>
</html>

