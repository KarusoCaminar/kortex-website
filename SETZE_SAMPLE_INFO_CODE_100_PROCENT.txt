// --- Code fÃ¼r Setze Sample-Info (100% KORREKT) ---

console.log('ğŸ” [Setze Sample-Info] Start');
console.log('ğŸ“¦ $binary vorhanden:', !!$binary);
console.log('ğŸ“¦ $json:', JSON.stringify($json, null, 2));

// Sample-Parameter
const sample = String($json.query?.sample || '').trim();
console.log('ğŸ“ Sample:', sample || 'Upload');

let binaryData = null;

// FALL 1: Input kommt von "Lade Sample X" â†’ $binary hat die Daten
if ($binary && typeof $binary === 'object') {
    const binaryKeys = Object.keys($binary);
    if (binaryKeys.length > 0) {
        binaryData = $binary;
        console.log('âœ… Binary vom aktuellen Item (von Lade Sample X):', binaryKeys);
    }
}

// FALL 2: Input kommt von "Ist Sample?" (False Branch) â†’ KEINE Binary-Daten!
// ABER: Wenn sample vorhanden ist, wurde "Lade Sample X" bereits im True Branch ausgefÃ¼hrt!
// â†’ Hole Binary von "Lade Sample X" Node!
if (!binaryData && sample) {
    console.log('âš ï¸ Input kommt von "Ist Sample?" False Branch - hole Binary von "Lade Sample X"');
    try {
        let nodeName = null;
        if (sample === '1') nodeName = 'Lade Sample 1';
        else if (sample === '2') nodeName = 'Lade Sample 2';
        else if (sample === '3') nodeName = 'Lade Sample 3';
        
        if (nodeName) {
            console.log('ğŸ” Hole Binary von:', nodeName);
            const node = $(nodeName);
            
            // Versuche verschiedene Binary-Strukturen
            if (node?.binary) {
                binaryData = node.binary;
                console.log('âœ… Binary von', nodeName, '(binary)');
            } else if (node?.item?.binary) {
                binaryData = node.item.binary;
                console.log('âœ… Binary von', nodeName, '(item.binary)');
            } else if (node?.item?.binary?.data) {
                binaryData = node.item.binary;
                console.log('âœ… Binary von', nodeName, '(item.binary.data)');
            } else {
                console.error('âŒ Node', nodeName, 'hat keine Binary-Daten gefunden');
                console.error('ğŸ“‹ Node:', node);
            }
        }
    } catch (e) {
        console.error('âŒ Fehler beim Holen von', nodeName, ':', e.message);
        console.error('ğŸ“‹ Error Stack:', e.stack);
    }
}

// FALL 3: Upload (kein sample Parameter) â†’ Binary vom Webhook
if (!binaryData && !sample) {
    console.log('ğŸ“¤ Upload: Hole Binary vom Webhook');
    try {
        const webhook = $('Business Card Upload');
        if (webhook?.binary) {
            binaryData = webhook.binary;
            console.log('âœ… Binary vom Webhook (binary)');
        } else if (webhook?.item?.binary) {
            binaryData = webhook.item.binary;
            console.log('âœ… Binary vom Webhook (item.binary)');
        } else if (webhook?.item?.binary?.data) {
            binaryData = webhook.item.binary;
            console.log('âœ… Binary vom Webhook (item.binary.data)');
        } else {
            console.error('âŒ Webhook hat keine Binary-Daten');
        }
    } catch (e) {
        console.error('âŒ Fehler beim Holen vom Webhook:', e.message);
    }
}

// KRITISCH: PrÃ¼fe ob Binary vorhanden ist
if (!binaryData || (typeof binaryData === 'object' && Object.keys(binaryData).length === 0)) {
    console.error('âŒ KRITISCH: KEINE Binary-Daten gefunden!');
    console.error('ğŸ“ Sample:', sample);
    console.error('ğŸ“¦ $binary:', $binary);
    console.error('ğŸ“¦ binaryData:', binaryData);
    console.error('ğŸ“‹ Input JSON:', JSON.stringify($json, null, 2));
    
    // ERROR: Wirf einen Fehler mit detaillierter Info
    throw new Error(`Binary-Daten fehlen! Sample: "${sample || 'Upload'}". PrÃ¼fe ob "Lade Sample ${sample}" Node ausgefÃ¼hrt wurde.`);
}

console.log('âœ… Binary gefunden:', Object.keys(binaryData));
console.log('âœ… Binary Keys:', Object.keys(binaryData));

// Return Item mit Binary
return [{
    json: {
        ...$json,
        sample: sample,
        source: sample ? `Sample ${sample}` : 'Upload'
    },
    binary: binaryData
}];

